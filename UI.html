<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">

	<style type="text/css">
		body {
			font-family: sans-serif;
			font-size: small;
			background-color: #c6eafb;
		}

		hr {
			color: #00ADEF;
			background-color: #00ADEF;
			height: 6px;
			border: none;
			padding-left: 0px;
		}

		table {
			border-collapse: collapse;
			font-size: small;
		}

		th, td {
			padding: 2px;
			text-align: left;
		}

		table, th, td {
			border: 1px solid black;
		}

		th {
			background-color: #00ADEF;
			color: white;
		}

		tr:nth-child(even) {
			background-color: #b6daeb;
		}

		a.nav-off {
			text-decoration: none;
			color: #FFFFFF;
		}

		a.nav-on {
			text-decoration: none;
			color: #FFFF00;
		}

		td.nav-off {
			text-decoration: none;
			background-color: #1a75bc;
			text-align: center;
		}

		td.nav-on {
			text-decoration: none;
			background-color: #00ADEF;
			text-align: center;
		}

	</style>

	<script type="text/javascript">

		const _rootMenu =
		[{
			text: 'MAME-AO',
			title: 'MAME-AO',
			href: '/',
			menu: [
				{
					text: 'Machines',
					title: 'Start Machines',
					href: '/machines',
					menu: [
						{
							text: 'Arcade Good',
							title: 'Arcade Machines - Status Good',
							href: '/machines/arcade-good',
						},
						{
							text: 'Arcade Imperfect',
							title: 'Arcade Machines - Status Imperfect',
							href: '/machines/arcade-imperfect',
						},
						{
							text: 'Compters & Consoles Good',
							title: 'Compters & Consoles with software - status good',
							href: '/machines/computer-console-good',
						},
						{
							text: 'Compters & Consoles Imperfect',
							title: 'Compters & Consoles with software - status imperfect',
							href: '/machines/computer-console-imperfect',
						},
						{
							text: 'Other Good',
							title: 'Other Systems without software - status good',
							href: '/machines/other-good',
						},
						{
							text: 'Other Imperfect',
							title: 'Other Systems without software - status imperfect',
							href: '/machines/other-imperfect',
						},
						{
							text: 'Everything',
							title: 'Everything',
							href: '/machines/everything',
						},
						{
							text: 'Favorites',
							title: 'Favorites',
							href: '/machines/favorites',
						},

					],
				},
				{
					text: 'Saved State',
					title: 'View saved state',
					href: '/saved',
				},
				{
					text: 'View Reports',
					title: 'View reports',
					href: '/view-reports',
				},
				{
					text: 'Run Reports',
					title: 'Run reports',
					href: '/reports',
					menu: [
						{
							text: 'Source Exists',
							title: 'Check if assets exist in source',
							href: '/reports/source-exists',
						},
						{
							text: 'Asset Sizes',
							title: 'Information about machine asset sizes',
							href: '/reports/machine-sizes',
						},
					],
				},
				{
					text: 'About',
					title: 'Information',
					href: '/about',
				},
			],
		}];

		//
		// Main
		//

		let _baseUrl;
		let _parameters;
		let _path;
		let _pathParts;
		let _info;

		const main = async () => {

			//
			// Setup
			//

			getRequestInfo();

			_info = await (await fetch(`${_baseUrl}/api/info`)).json();

			displayMenu();

			//
			// Route
			//

			switch (_path) {
				case '/about':
					await about();
					break;
			}

		}

		//
		// About
		//

		const about = async () => {

            const canvas = getCanvas();


            canvas.innerHTML = renderHtmlTable(_info);

		}

		//
		// Tools
		//

		const sleep = ms => new Promise(r => setTimeout(r, ms));

        const getCanvas = () => {
            const page = document.getElementById('canvas');
			page.innerHTML = '';
			return page;
		}

		const getRequestInfo = () => {

			// URL & paramters

			_baseUrl = window.location.origin;

			_parameters = {};

			if (window.location.href.includes('?')) {

				const parts = window.location.href.split('?')[1].split('&');
				parts.forEach((part) => {
					const pair = part.split('=');
					_parameters[pair[0]] = pair[1];
				});

				console.log(parts);
			}

			console.log(`baseUrl: ${_baseUrl}`);

            Object.keys(_parameters).forEach((key) => {
                console.log(`parameters : ${key} : ${_parameters[key]}`);
			});

			// Path

			_path = document.location.pathname;

			_pathParts = [];

			if (_path === '/') {
				_pathParts.push('/');
			} else {
				_path.split('/').forEach((part) => {
					if (part !== undefined) {
						let prev = '';
						if (_pathParts.length > 1)
							prev = _pathParts[_pathParts.length - 1];

						_pathParts.push(prev + '/' + part);
					}
				});
			}

			console.log(`path: ${_path}`);

			_pathParts.forEach((part, index) => {
				console.log(`pathPart : ${index} : ${part}`);
			});
		}

		const htmlEncode = (html) => html.replace(/[&<>'"]/g,
			tag => ({
				'&': '&amp;',
				'<': '&lt;',
				'>': '&gt;',
				"'": '&#39;',
				'"': '&quot;'
			}[tag]));

		const renderHtmlTable = (data) => {
			if (data == null)
				return 'null';

			if (typeof data !== 'object')
				return htmlEncode(JSON.stringify(data));

			if (Array.isArray(data) === false) {
				data = [data];
			}

			if (data.length === 0)
				return '[]';

			if (typeof data[0] !== 'object')
				return htmlEncode(JSON.stringify(data));

			const columnNames = [];
			data.forEach((row) => {
				Object.keys(row).forEach(columnName => {
					if (columnNames.includes(columnName) === false)
						columnNames.push(columnName);
				});
			});

			let table = '';

			table += '<table>';
			table += '<tr>';
			columnNames.forEach(columnName => {
				table += `<th>${columnName}</th>`;
			});
			table += '</tr>';

			data.forEach((row) => {
				table += '<tr>';
				columnNames.forEach(columnName => {
					let value = '';
					if (row[columnName] !== undefined)
						value = renderHtmlTable(row[columnName]);

					table += `<td>${value}</td>`;
				});
				table += '</tr>';
			});

			table += '</table>';

			return table;
		};

		//
		// Menu
		//

		const displayMenu = () => {

			// TODO: Redirect to bottom left document.location =

			const versions = `V${_info.version} (${_info.mame_version})`;

			_rootMenu[0].text = `MAME-AO ${versions}`;
			_rootMenu[0].title = versions;

			displayMenuWalk(_rootMenu);
		}

		const displayMenuWalk = (menu) => {

			const nav = document.getElementById('nav');

			const table = document.createElement('table');
			table.style = "width: 100%;";

			const row = document.createElement('tr');

			let found;

			menu.forEach((item) => {
				const cell = document.createElement('td');

				let itemClass = 'nav-off';

				if (_pathParts.includes(item.href)) {

					itemClass = 'nav-on';
					found = item;
					document.title = `MAME-AO ${item.title}`;
				}

				cell.className = itemClass;

				cell.innerHTML = `<a href="${item.href}" title="${item.title}" class="${itemClass}">${item.text}</a>`;

				row.appendChild(cell);
			});

			table.appendChild(row);
			nav.appendChild(table);

			if (found && found.menu)
				displayMenuWalk(found.menu);
		}

		//
		// Load
		//

		window.onload = main;

	</script>

</head>
<body>

	<nav id="nav">
	</nav>

	<hr />
	
	<div id="canvas">
		<p>This is the new UI for MAME-AO. It is not ready yet.</p>
	</div>

</body>
</html>
