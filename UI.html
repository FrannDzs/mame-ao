<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">

	<style type="text/css">
		body {
			font-family: sans-serif;
			font-size: small;
			background-color: #c6eafb;
		}

		hr {
			color: #00ADEF;
			background-color: #00ADEF;
			height: 6px;
			border: none;
			padding-left: 0px;
		}

		table {
			border-collapse: collapse;
			font-size: small;
		}

		th, td {
			padding: 2px;
			text-align: left;
		}

		table, th, td {
			border: 1px solid black;
		}

		th {
			background-color: #00ADEF;
			color: white;
		}

		tr:nth-child(even) {
			background-color: #b6daeb;
		}

		a.nav-off {
			text-decoration: none;
			color: #FFFFFF;
		}

		a.nav-on {
			text-decoration: none;
			color: #FFFF00;
		}

		td.nav-off {
			text-decoration: none;
			background-color: #1a75bc;
			text-align: center;
		}

		td.nav-on {
			text-decoration: none;
			background-color: #00ADEF;
			text-align: center;
		}

	</style>

	<script type="text/javascript">

		const _rootMenu =
		[{
			text: 'MAME-AO',
			title: 'MAME-AO',
			href: '/',
			menu: [
				{
					text: 'Machines',
					title: 'Start Machines',
					href: '/machines',
				},
				{
					text: 'Saved State',
					title: 'View saved state',
					href: '/saved',
				},
				{
					text: 'View Reports',
					title: 'View reports',
					href: '/view-reports',
				},
				{
					text: 'Run Reports',
					title: 'Run reports',
					href: '/reports',
					menu: [
						{
							text: 'Source Exists',
							title: 'Check if assets exist in source',
							href: '/reports/source-exists',
						},
						{
							text: 'Asset Sizes',
							title: 'Information about machine asset sizes',
							href: '/reports/machine-sizes',
						},
					],
				},
				{
					text: 'About',
					title: 'Information',
					href: '/about',
				},
			],
		}];

		//
		// Main
		//

		let _baseUrl;
		let _parameters;
		let _path;
		let _pathParts;
		let _info;
		let _currentMenu;

		const main = async () => {

			//
			// Setup
			//

			getRequestInfo();

			_info = await (await fetch(`${_baseUrl}/api/info`)).json();

			// load machines menu
			if (_pathParts.includes('/machines')) {
				const dataProfiles = (await (await fetch(`${_baseUrl}/api/profiles`)).json());

				_rootMenu[0].menu[0].menu = dataProfiles.results.map((profile) => {
					return {
						text: profile.text,
						title: profile.description,
						href: `/machines/${profile.key}`,
					};
				});
			}

			displayMenu();

			//
			// Route
			//

			if (_pathParts.includes('/machines') && _pathParts.length === 3) {
				await machines();
				return;
			}

			switch (_path) {

				case '/saved':
					await saved();
					break;

				case '/view-reports':
					await viewReports();
					break;

				case '/about':
					await about();
					break;
			}

		}

		//
		// About
		//
		const about = async () => {

            const canvas = getCanvas();


            canvas.innerHTML = renderHtmlTable(_info);
		}

		//
		// Machines
		//
		const machines = async () => {

			const canvas = getCanvas();

			const profileKey = _pathParts[2].substring(10);

			const machinesData = await (await fetch(`${_baseUrl}/api/machines?profile=${profileKey}&offset=${_parameters.offset}&search=${_parameters.search}`)).json();

			const columnDefs = [
				{ heading: '', columnName: 'ao_image' },
				{ heading: 'fav', columnName: 'favorite' },
				{ heading: 'name', columnName: 'name' },
				{ heading: 'description', columnName: 'description' },
				{ heading: 'year', columnName: 'year' },
				{ heading: 'manufacturer', columnName: 'manufacturer' },
				{ heading: 'roms', columnName: 'ao_rom_count' },
				{ heading: 'disks', columnName: 'ao_disk_count' },
				{ heading: 'lists', columnName: 'ao_softwarelist_count' },
				{ heading: 'romof', columnName: 'romof' },
				{ heading: 'cloneof', columnName: 'cloneof' },
				{ heading: 'status', columnName: 'status' },
				{ heading: 'emulation', columnName: 'emulation' },
			];

			const table = document.createElement('table');
			table.style = 'width:100%;';

			// Headings
			const headRow = document.createElement('tr');
			columnDefs.forEach((colDef) => {
				const cell = document.createElement('th');
				cell.innerHTML = colDef.heading;
				headRow.appendChild(cell);
			});
			table.appendChild(headRow);

			// Rows
			machinesData.results.forEach((row, rowIndex) => {
				const tableRow = document.createElement('tr');

				columnDefs.forEach((colDef) => {
					const cell = document.createElement('td');

					switch (colDef.columnName) {
						case 'ao_image':
							if (row.ao_softwarelist_count > 0)
								cell.innerHTML = `<a id="${row.name}" href="./?machine=${row.name}"><div style="width:128px;height:128px;"><img src="${row.ao_image}" loading="lazy" /></div></a>`;
							else
								cell.innerHTML = `<a id="${row.name}" onclick="runCommand(this.id)" href="javascript:void(0);"><div style="width:128px;height:128px;"><img src="${row.ao_image}" loading="lazy" /></div></a>`;
							break;

						case 'name':
							cell.innerHTML = `<a href="https://mame.spludlow.co.uk/Machine.aspx?name=${row.name}" target="_blank">${row.name}</a>`;
							break;

						case 'favorite':
							cell.innerHTML = `<input type="checkbox" id="fav_${row.name}" onclick="changeFavoriteMachine(this.id)" ${row.favorite ? 'checked' : ''}>`;
							break;

						default:
							if (row[colDef.columnName] !== undefined)
								cell.innerHTML = row[colDef.columnName];
							break;
					}

					if (cell.innerHTML === '0')
						cell.innerHTML = '';

					if (row.favorite === true) {
						if ((rowIndex % 2) == 0)
							cell.style.background = '#cccc00';
						else
							cell.style.background = '#e6e600';
					}

					tableRow.appendChild(cell);
				});

				tableRow.id = `row${rowIndex}`;

				table.appendChild(tableRow);
			});

			//canvas.appendChild(table);

			

			const limit = 100;

			const navHtml = `<a href="${_path}?offset=${_parameters.offset - limit}&search=${_parameters.search}">PREV</a>` +
							'&nbsp; - &nbsp;' +
							`<a href="${_path}?offset=${_parameters.offset + limit}&search=${_parameters.search}">NEXT</a>`;

			let html = '';

			html += `<input id="inputText" type="text" value="${_parameters.search}" style="width:480px;" />`;
			html += '<button type="submit" onclick="machineSearch(); return false;">Search</button>';
			html += '<hr />';
			html += `<nav>${navHtml}</nav>`;
			html += '<div id="results"></div>';
			html += `<nav>${navHtml}</nav>`;

			const div = document.createElement('div');
			div.innerHTML = html;
			canvas.appendChild(div);

			const results = document.getElementById('results');

			results.appendChild(table);

			const inputText = document.getElementById('inputText');
			inputText.focus();

			//const debug = document.createElement('div');
			//debug.innerHTML = renderHtmlTable(machinesData);
			//canvas.appendChild(debug);
		}
		const machineSearch = async () => {

			const inputText = document.getElementById('inputText');

			document.location = `${_path}?search=${encodeURIComponent(inputText.value)}`;
			
		}

		const changeFavoriteMachine = async (checkBoxId) => {
			const checkBox = document.getElementById(checkBoxId);

			const name = checkBoxId.substring(4);

			const command = checkBox.checked ? ".favm" : ".favmx";

			await runCommand(`${command} ${name}`);

			const row = checkBox.parentElement.parentElement;

			const rowIndex = parseInt(row.id.substring(3), 10);

			for (let cellIndex = 0; cellIndex < row.cells.length; ++cellIndex) {
				const cell = row.cells[cellIndex];

				if (checkBox.checked === false) {
					cell.style.background = '';
				} else {
					if ((rowIndex % 2) == 0)
						cell.style.background = '#cccc00';
					else
						cell.style.background = '#e6e600';
				}
			}
		}

		//
		// Saved state
		//
		const saved = async () => {

			const canvas = getCanvas();

			const savedData = await (await fetch(`${_baseUrl}/api/list`)).json();

			canvas.innerHTML = renderHtmlTable(savedData);
		}

		//
		// View Reports
		//
		const viewReports = async () => {

			const canvas = getCanvas();

			const reportsData = await (await fetch(`${_baseUrl}/api/reports`)).json();

			canvas.innerHTML = renderHtmlTable(reportsData);

		}

		//
		// Tools
		//

		const sleep = ms => new Promise(r => setTimeout(r, ms));

        const getCanvas = () => {
            const page = document.getElementById('canvas');
			page.innerHTML = '';
			return page;
		}

		const runCommand = async (line) => {

			const response = await fetch(`${_baseUrl}/api/command?line=${encodeURIComponent(line)}`);

			const result = await response.json();

			console.log(result);

			if (response.status !== 200)
				alert(result.message);
		}

		const getRequestInfo = () => {

			// URL & paramters

			_baseUrl = window.location.origin;

			_parameters = {};

			if (window.location.href.includes('?')) {

				const parts = window.location.href.split('?')[1].split('&');
				parts.forEach((part) => {
					const pair = part.split('=');
					_parameters[pair[0]] = pair[1];
				});

				console.log(parts);
			}

			if (_parameters['offset'] === undefined)
				_parameters['offset'] = 0;
			else
				_parameters['offset'] = parseInt(_parameters['offset'], 10);

			if (_parameters['search'] === undefined)
				_parameters['search'] = '';

			console.log(`baseUrl: ${_baseUrl}`);

            Object.keys(_parameters).forEach((key) => {
                console.log(`parameters : ${key} : ${_parameters[key]}`);
			});

			// Path

			_path = document.location.pathname;

			_pathParts = [];

			if (_path === '/') {
				_pathParts.push('/');
			} else {
				_path.split('/').forEach((part) => {
					if (part !== undefined) {
						let prev = '';
						if (_pathParts.length > 1)
							prev = _pathParts[_pathParts.length - 1];

						_pathParts.push(prev + '/' + part);
					}
				});
			}

			console.log(`path: ${_path}`);

			_pathParts.forEach((part, index) => {
				console.log(`pathPart : ${index} : ${part}`);
			});
		}

		const htmlEncode = (html) => html.replace(/[&<>'"]/g,
			tag => ({
				'&': '&amp;',
				'<': '&lt;',
				'>': '&gt;',
				"'": '&#39;',
				'"': '&quot;'
			}[tag]));

		const renderHtmlTable = (data) => {
			if (data == null)
				return 'null';

			if (typeof data !== 'object')
				return htmlEncode(JSON.stringify(data));

			if (Array.isArray(data) === false) {
				data = [data];
			}

			if (data.length === 0)
				return '[]';

			if (typeof data[0] !== 'object')
				return htmlEncode(JSON.stringify(data));

			const columnNames = [];
			data.forEach((row) => {
				Object.keys(row).forEach(columnName => {
					if (columnNames.includes(columnName) === false)
						columnNames.push(columnName);
				});
			});

			let table = '';

			table += '<table>';
			table += '<tr>';
			columnNames.forEach(columnName => {
				table += `<th>${columnName}</th>`;
			});
			table += '</tr>';

			data.forEach((row) => {
				table += '<tr>';
				columnNames.forEach(columnName => {
					let value = '';
					if (row[columnName] !== undefined)
						value = renderHtmlTable(row[columnName]);

					table += `<td>${value}</td>`;
				});
				table += '</tr>';
			});

			table += '</table>';

			return table;
		};

		//
		// Menu
		//

		const displayMenu = () => {

			const versions = `V${_info.version} (${_info.mame_version})`;

			_rootMenu[0].text = `MAME-AO ${versions}`;
			_rootMenu[0].title = versions;

			displayMenuWalk(_rootMenu);

			if (_currentMenu && _currentMenu.menu && _currentMenu.menu[0].href)
				document.location = `${_baseUrl}${_currentMenu.menu[0].href}`;
		}

		const displayMenuWalk = (menu) => {

			const nav = document.getElementById('nav');
			const heading = document.getElementById('heading');

			const table = document.createElement('table');
			table.style = "width: 100%;";

			const row = document.createElement('tr');

			let found;

			menu.forEach((item) => {
				const cell = document.createElement('td');

				let itemClass = 'nav-off';

				if (_pathParts.includes(item.href)) {

					itemClass = 'nav-on';
					found = item;
					document.title = `MAME-AO ${item.title}`;
					heading.innerHTML = `MAME-AO ${item.title}`;
				}

				if (_path === item.href)
					_currentMenu = item;

				cell.className = itemClass;

				cell.innerHTML = `<a href="${item.href}" title="${item.title}" class="${itemClass}">${item.text}</a>`;

				row.appendChild(cell);
			});

			table.appendChild(row);
			nav.appendChild(table);

			if (found && found.menu)
				displayMenuWalk(found.menu);
		}

		//
		// Load
		//

		window.onload = main;

	</script>

</head>
<body>

	<h1 id="heading"></h1>

	<nav id="nav">
	</nav>

	<hr />
	<form>
		<div id="canvas">
			<p>This is the new UI for MAME-AO. It is not ready yet.</p>
		</div>
	</form>

</body>
</html>
